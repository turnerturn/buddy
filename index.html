<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buddy Copilot Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background-color: #e9ecef;
    }

    .chat-bubble {
      max-width: 75%;
      padding: 0.75rem 1rem;
      border-radius: 15px;
      margin-bottom: 0.5rem;
      word-wrap: break-word;
    }

    .user-message {
      background-color: #d1e7dd;
      align-self: flex-end;
    }

    .assistant-message {
      background-color: #ffffff;
      align-self: flex-start;
    }

    .message-row {
      display: flex;
      flex-direction: column;
    }

    .chat-input {
      display: flex;
      padding: 0.75rem;
      background-color: #ffffff;
      border-top: 1px solid #dee2e6;
    }

    .chat-input input {
      flex-grow: 1;
      margin-right: 0.5rem;
    }

    textarea {
      resize: none;
    }

    .edit-btn {
      margin-left: auto;
      margin-top: 0.25rem;
      width: 100px;
    }

    @media (max-width: 768px) {
      .chat-bubble {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Buddy Copilot</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="#">Chat</a></li>
          <li class="nav-item"><a class="nav-link" href="#">FAQs</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Support</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Chat View -->
  <div class="chat-container d-flex flex-column" id="chatLog"></div>

  <!-- Chat Input -->
  <div class="chat-input">
    <input type="text" class="form-control" id="userInput" placeholder="Ask a question..." />
    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
  </div>
<script>
  const apiKey = "__SECRET_PLACEHOLDER__";
  console.log("Secret loaded securely at build...");
    const systemPrompt = `You are Buddy, an embedded IT support Copilot assistant.

You must strictly follow the agent behavior rules defined in the Copilot Agent Instructions, available at:

➡️ https://raw.githubusercontent.com/turnerturn/buddy/refs/heads/main/copilot-agent-instructions.md

The instructions define how you should:
- Answer only with accurate, known IT support guidance
- Never make assumptions or guesses
- Reference FAQ responses from the chronological list

The source of truth for user-facing support content is the FAQ markdown, which is linked inside the instructions document. Always reference the most recent matching FAQ when answering user questions. If two FAQ entries conflict, the most recent entry takes precedence.

If a user inquiry is not covered in the known instructions or FAQ content, do not fabricate a response. Instead, reply with:

> “I'm not able to provide a solution based on current knowledge. You may consider updating our FAQ list or contacting IT Support for assistance.”

Use clear, concise formatting:
- Use Q/A for direct answers from FAQ
- Use step-by-step instructions for known support tasks
- Never return generic advice or hallucinated features

You are not a general-purpose assistant. Your sole role is to act as an interface for the official instructions and FAQ content.`;

    let messages = [ { role: "system", content: systemPrompt } ];

    function renderMessages() {
      const chatLog = document.getElementById("chatLog");
      chatLog.innerHTML = "";
      messages.forEach((msg, index) => {
        if (msg.role === "user" || msg.role === "assistant") {
          const msgDiv = document.createElement("div");
          msgDiv.className = "message-row";
          const bubble = document.createElement("div");
          bubble.className = `chat-bubble ${msg.role === "user" ? "user-message ms-auto" : "assistant-message me-auto"}`;
          bubble.innerHTML = msg.content;
          msgDiv.appendChild(bubble);

          if (msg.role === "user") {
            const editArea = document.createElement("textarea");
            editArea.rows = 2;
            editArea.className = "form-control mt-1";
            editArea.value = msg.content;
            editArea.id = "edit-" + index;

            const editBtn = document.createElement("button");
            editBtn.textContent = "Update";
            editBtn.className = "btn btn-outline-secondary btn-sm edit-btn";
            editBtn.onclick = () => {
              const newText = document.getElementById("edit-" + index).value;
              messages[index].content = newText;
              renderMessages();
            };

            msgDiv.appendChild(editArea);
            msgDiv.appendChild(editBtn);
          }

          chatLog.appendChild(msgDiv);
        }
      });
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    async function sendMessage() {
      const userInput = document.getElementById("userInput");
      const content = userInput.value.trim();
      if (!content) return;
      messages.push({ role: "user", content: content });
      userInput.value = "";
      renderMessages();

      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${apiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "gpt-4",
          messages: messages,
          temperature: 0.3
        })
      });

      const data = await res.json();
      const reply = data.choices[0].message.content;
      messages.push({ role: "assistant", content: reply });
      renderMessages();
    }

    renderMessages();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
